<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Offline AI — Chromebook</title>
  <style>
    body { background:#0f1724; color:#e6eef8; font-family:sans-serif; padding:20px; }
    #chat { background:#111827; border-radius:8px; padding:12px; height:300px; overflow-y:auto; }
    .msg { margin:6px 0; padding:8px 12px; border-radius:6px; max-width:70%; }
    .user { background:#7c3aed; color:#fff; margin-left:auto; }
    .bot { background:#1e293b; }
    textarea { width:100%; margin-top:10px; padding:10px; border-radius:6px; background:#0b1220; color:#fff; }
    button { margin-top:10px; padding:10px 14px; border:none; border-radius:6px; background:#7c3aed; color:#fff; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Offline AI — Chromebook</h1>
  <div id="chat"></div>
  <textarea id="prompt" placeholder="Type your message..."></textarea>
  <button id="send">Send</button>
  <p id="status">Status: idle</p>

  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js';

    const chat = document.getElementById("chat");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("send");
    const statusEl = document.getElementById("status");

    let generator = null;

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.className = "msg " + (role === "user" ? "user" : "bot");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function loadModel() {
      if (generator) return;
      statusEl.textContent = "Status: loading model...";
      const modelId = "Xenova/tiny-random-gpt2"; // always works, no auth needed
      generator = await pipeline("text-generation", modelId, {
        progress_callback: p => statusEl.textContent = "Loading: " + Math.round(p*100) + "%"
      });
      statusEl.textContent = "Status: model loaded";
    }

    sendBtn.addEventListener("click", async () => {
      const prompt = promptEl.value.trim();
      if (!prompt) return;
      appendMessage("user", prompt);
      promptEl.value = "";
      await loadModel();
      statusEl.textContent = "Status: generating...";
      try {
        const out = await generator(prompt, { max_new_tokens: 50 });
        const reply = out[0].generated_text.replace(prompt, "").trim();
        appendMessage("bot", reply);
        statusEl.textContent = "Status: idle";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Status: error";
      }
    });

    // Register service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").then(
        () => console.log("SW registered"),
        e => console.warn("SW failed", e)
      );
    }
  </script>
</body>
</html>
